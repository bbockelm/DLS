#!/usr/bin/env python

#
# $Id: dls-get-se,v 1.14 2008/02/21 10:02:26 delgadop Exp $
#
# DLS Client. $Name:  $.
# Antonio Delgado Peris. CIEMAT. CMS.
# 

#########################################
# Imports 
#########################################
import dlsApi
from dlsDataObjects import DlsLocation, DlsFileBlock, DlsEntry
import dlsClient
from dlsCommandsCommon import *
import time
import sys
import getopt

ADMITTED_IFACE_TYPES = ["DLS_TYPE_LFC", "DLS_TYPE_MYSQL", "DLS_TYPE_DBS", "DLS_TYPE_PHEDEX", "DLS_TYPE_DLI"]


################## GLOBAL CONSTANTS ########################
THIS_YEAR = time.localtime()[0]


######################### FUNCTIONS ########################

def usage():
   """
    Provides usage information
   """
   print "Usage: dls-get-se [-v, -e, -i, -l, --dbs-conf, --show-prod] <fileblock>"
   print "       dls-get-se [-v, -e, -i, -l, -p, --dbs-conf, --show-prod] -f <listing_file>"
   print "       dls-get-se -u"
   print "       dls-get-se -h"


def options():
   """
    Provides some information regarding the available options
   """
   print """Options summary:
   -h, --help
   -u, --usage
   -v, --verbose <verb_level>
   -e, --endpoint <endpoint>
   -i, --interface-type <iface_type>
   -l, --long
   -p, --partial-list
   -f, --from-file <filename>
       --dbs-conf <conf_file>
       --show-prod
   """
def example():
  """
   Provides with an example of correct use of the script
  """
  print """
  """

def help():
   """
    Provides some help information
   """
   print """Prints the locations holding a copy of the specified FileBlock. 


Specific notes for DBS and PhEDEx back-end (DLS_TYPE_DBS, DLS_TYPE_PHEDEX):

  The argument of this command will be taken as a FileBlock name pattern.
  (with '*' as wildcard). All the locations associated with the matching
  FileBlocks will be returned.

  The server endpoint is got from a string in the URL form, usually:
    "http[s]://hname[:port]/path/to/DLS".
  This endpoint is retrieved from several sources (in order of precedence):   
     - specified value for --endpoint option 
     - DLS_ENDPOINT environmental variable
     - (DBS only) specified URL in the configuration file (see --dbs-conf)
     - (PhEDEx only) DLS_PHEDEX_ENDPOINT environmental variable


Additional DLS_TYPE_PHEDEX notes:

  The --show-prod option can be used to turn off the filtering of
  prod-only FileBlock replicas. Use it only if you know what you are doing.


Additional DLS_TYPE_DBS notes:

  Currently, the DBS back-end does not support replica attributes, so the
  "-l" option is ignored.
  
  Apart from DBS endpoint, other configuration options may be specified for
  the underlying DBS interface (e.g. "level" for DBS logging level) in a
  configuration file. The name of this file can be indicated with,
  in this order:
     - specified value for --dbs-conf option
     - DBS_CLIENT_CONFIG environmental variable


Specific notes for LFC back-end (DLS_TYPE_LFC):
  
  The argument of this command is the a FileBlock name.

  For long listing ("-l"), printed attributes are: accees time, pin time,
  file type ('P' for permanent or 'V' for volatile) and SURL.

  The server endpoint should be of the form: "hname[:port][/path/to/DLS]",
  where a default port is used if not specified, and the path to DLS is
  required. The server endpoint is retrieved from (in orden of precedence):
     - specified value for --endpoint option 
     - DLS_ENDPOINT environmental variable


Specific notes for DLI back-end (DLS_TYPE_DLI):
 
  Long listing is not supported.

  All the other notes for LFC back-end apply to DLI as well.
  

Options: 

The "-l" option will cause some location attributes are printed after the SE name.
Printed attributes depend on the DLS implementation.

The "-f" option can be used to retrieve FileBlock names from a file rather
than from the given arguments. The file must contain one line per FileBlock
to be listed.

The "-p" option can be used together with "-f" to specify that even if there
are errors in the listing of locations for a fileblock specified in the file, 
the command must keep trying with the rest of fileblocks (by default, it will
break on error at the first problem). In the case of errors, a warning is
printed and the corresponding fileblock is skipped in the resulting locations
list. The "-p" option makes no sense if "-f" is not used.

The --show-prod option is only understood by the PhEDEx back-end (see notes) and
ignored by the rest.
 """
   commonHelpText(ADMITTED_IFACE_TYPES)
   options()
   usage()



def showLocations(iface, lineList, longList, iface_type, errorTolerant, showProd, verbose):
   """
    Prints the locations which hold a copy of the specified
    FileBlock. lineList is a list of strings, each holding 
    a FileBlock name. 
    
    If longList is True, some attributes are also printed.
    Currently printed attributes are: atime, ptime, f_type.
    
    Throws DlsApiError if there is a problem in the DLS operation.
   """

   fbList = []
   for line in lineList:

      # Split
      line = (line.strip()).split()
      if(not line):
         continue

      # Get LFN
      lfn = line.pop(0)

      # Store all the FileBlocks 
      fbList.append(lfn)

   if(verbose >= 2):
      print "--DlsApi.getLocations(",
      for i in fbList: print i, ";",
      print ")"

   # Get the locations (and let the caller deal with the exception...)
   entryList = iface.getLocations(fbList, longList = longList, session = True, errorTolerant = errorTolerant, showProd = showProd)

   # Print the entries
   for entry in entryList:
      if (len(entryList) > 1):
         print "  FileBlock: " + entry.fileBlock.name
      for loc in entry.locations:
#         # In any case, print the host
#         print loc.host,
         if (not longList) or (iface_type=="DLS_TYPE_LFC"):
            print loc.host,
         else:
            print loc,

         if(iface_type=="DLS_TYPE_LFC" and longList):
#         if(longList):
            values = []
            for i in ["atime", "ptime", "f_type", "sfn"]:
               try:
                   values.append(loc.attribs[i])
               except KeyError, inst:
                   values.append("UNKNOWN")

            if(not (values[0] == "UNKNOWN")):
               time_tuple = time.localtime(loc.attribs["atime"])
               if(time_tuple[0] != THIS_YEAR):
                  fmt = "%b %d %Y"
               else:
                  fmt = "%b %d %H:%M"
               print '\t', time.strftime(fmt, time_tuple), '\t',
            else:
               print '\t', values[1], '\t',

            print values[1], "\t",
            print values[2], "\t",
            print values[3],

#         if(iface_type != "DLS_TYPE_LFC" and longList):
#            print loc.attribs,

         print
         
 

            

###################### MAIN FUNCTION ########################

def main(pArgs):
   """
    Performes the main task of the script (invoked directly).
    For information on its functionality, please call the help function.
   """

 # Options and args... 
 
   longoptions=["help", "usage", "long", "endpoint=", "interface-type=", "verbose=", "from-file=", "partial-list", "dbs-conf=", "show-prod"]
   try:
      optlist, args = getopt.getopt(pArgs, 'hule:i:v:f:p', longoptions)
   except getopt.GetoptError, inst:
      sys.stderr.write("Bad usage: "+str(inst)+'\n')
      usage()
      sys.exit(OPT_ERROR)

   err=0
   longList = False
   dbsConf = None
   verbose = 1
   endpoint = None
   iface_type = None
   fromFile = False
   fname=""
   errorTolerant = False
   showProd = False
   for opt, val in optlist:
       if opt in ("-h", "--help"):
           help()
           return 0

       elif opt in ("-u", "--usage"):
           usage()
           return 0
           
       elif opt in ("-l", "--long"):
           longList = True
           
       elif opt in ("", "--dbs-conf"):
           dbsConf = val

       elif opt in ("", "--show-prod"):
           showProd = True

       elif opt in ("-e","--endpoint"):
           endpoint = val

       elif opt in ("-p","--partial-list"):
           errorTolerant = True

       elif opt in ("-i", "--interface-type"):
           iface_type = val

       elif opt in ("-v", "--verbose"):
           verbose = check_verbosity_value(val)
           if(verbose == OPT_ERROR): return OPT_ERROR

       elif opt in ("-f","--from-file"):
           fromFile = True
           fname = val


   # Check the interface type (from options or environ)
   iface_type = check_iface_type(iface_type, ADMITTED_IFACE_TYPES)
   if (iface_type == TYPE_ERROR): return TYPE_ERROR


 # Check option combinations...
   if(errorTolerant and (not fromFile)):
      sys.stderr.write("Bad usage: The -p option can only be used together with -f"+'\n')
      usage()
      return OPT_ERROR

   # From file
   if(fromFile):
      try:
         file=open(fname, 'r')
      except IOError, inst:
         msg="The file "+fname+" could not be opened: "+str(inst)+"\n"
         sys.stderr.write(msg)
         return FILE_ERROR
      lineList=file.readlines()
      
   # From command line options
   else:
      if(len(args)<1):
         sys.stderr.write("Not enough input arguments\n")
         usage()
         return(OPT_ERROR)

      line=""
      for token in args:
         line += token +" "
      lineList = [line]

 # Create the interface binding
   try: 
      iface = create_iface_binding(iface_type, endpoint, dbsConf, verbose)
   except dlsApi.DlsApiError, inst:
      if(inst.rc):  err = inst.rc 
      else:           err = GENERIC_ERROR
      msg = "Error when binding the DLS interface: " + str(inst)
      sys.stderr.write(msg+"\n")
      return err

   
 # Do the query (under session)
   try:
     showLocations(iface, lineList, longList, iface_type, errorTolerant, showProd, verbose)
   except dlsApi.DlsApiError, inst:         
      if(inst.rc):  err = inst.rc 
      else:           err = GENERIC_ERROR
      msg = "Error in the DLS query: %s." % str(inst)
      sys.stderr.write(msg+'\n')


 # Finally, return error code
   return err



######################### SCRIPT ###########################

if __name__ == "__main__":
  sys.exit(main(sys.argv[1:]))
